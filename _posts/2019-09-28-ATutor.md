---
title: "Reviewing old vulns from ATutor 2.2.1"
date: 2019-09-28
tags: [ATutor, oswe, awae, ATutor RCE, ATutor sqli, ATutor exploit, offensive security]
header:
  image: "/images/ATutor/header.jpg"
---


A couple of weeks ago i was looking at the new online course from offensive security (AWAE) and it seems very interesting, but unfortunately i can't afford it because i'm only a student, so i decided to look at the [syllabus](https://www.offensive-security.com/documentation/awae-syllabus.pdf), after reading it i decided to set up a local lab with all those apps and try to exploit them by myself, today i'm going to be writing about ATutor.

### ATutor 2.2.1 SQLI

![ATutor Login](/images/ATutor/login.png)
<sub><sup>Figure 1. Login page from ATutor 2.2.1</sup></sub>

I know that ATutor 2.2.1 has a lot of sql injection vulns but i will start analyzing CVE-2016-2555

*CVE-2016-2555: SQL injection vulnerability in include/lib/mysql_connect.inc.php in ATutor 2.2.1 allows remote attackers to execute arbitrary SQL commands via the searchFriends function to friends.inc.php*

So far we know that there's a SQL injection at the searchFriends function, but i want to find the vuln without using that information, so i launched burp on my local machine and start crawling the website to find interesting endpoints (see Figure 2.)

![Burp Crawl](/images/ATutor/crawl.png)
 <sub><sup>Figure 2. Crawl burp results</sup></sub>

As we can see in figure 2. we have a lot of requests with parameters, now we can start looking at all the request and read the source code to find vulns or we can try to test each parameter to see if we can get something interesting (test if something brokes), i'll go with the second option and start testing each parameter/fuzzing to see if we can get something useful.

After testing each parameter i found three interesting things but i'll start analyzing the one related to the CVE-2016-2555, as we can see at Figure 3. if we add an ' to the search_friends parameter we get an error

![error1](/images/ATutor/rsql.png)
<sub><sup>Figure 3. Database error</sup></sub>

To understand a little more about this error, we can check the log file(see Figure 4.)

![error2](/images/ATutor/error.png)
<sub><sup>Figure 4. Content of log files</sup></sub>

As we can see in Figure 4 we have a syntax error (Unterminated quoted string) so it might be possible to exploit a sqli

Note: We can get the same result sending a POST request to /ATutor/mods/_standard/social/connections.php instead of index_public.php

Now to see if it's vulnerable to a sql injection and how to exploit it, we can analyze the source code

### Analyzing code from index_public.php
In figure 5. we have a piece of code from index_public.php (/ATutor/mods/_standard/social/index_public.php)

![code](/images/ATutor/publicCode.png)
<sub><sup>Figure 5. Piece of code from index_public.php</sup></sub>

That piece of code handles search friends requests, the first couple of lines make sure that the request contains the POST parameter search_friends_.$rand_key or the get parameter search_friends

Note: We can also use a GET request and send the parameter search_friends to get the SQL error, example: 
```
GET /ATutor/mods/_standard/social/index_public.php?search_friends=1' HTTP/1.1
Host: 192.168.1.35
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: es-AR,es;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Cookie: userActivity=Sun%20Sep%2029%202019%2012%3A00%3A34%20GMT-0300%20(-03); ATutorID=0p31nl64k0km8uageacilqaie7; userActivity=Sat%20Sep%2028%202019%2009%3A33%3A24%20GMT-0300%20(-03); flash=no; _ga=GA1.1.1934307875.1569617407; _gid=GA1.1.10755640.1569769198
Connection: close
Upgrade-Insecure-Requests: 1
```
Since it's the same if we send a GET or POST request from now on i'll use GET (because it will be easier to see the results)


After checking that the parameters are set, we have the following line

```
$search_field = $addslashes($_GET['search_friends']);
```

So it seems they are using $addslashes() to prevent sql injections, but what is $addslashes()? well, according to the ATutor developer documentation: $addslashes() quotes a string with slashes. 

and finally the last important line is:
```
$friends = searchFriends($search_field);
```
Which calls the searchFriends function and passes the search_field variable, so now we have two things to analyze, one is how the searchFriends function works and the other one is how $addslashes() works

i'll check first how $addslashes() works, why this one first? Because if we understand how this one works we could craft a payload to bypass it. 

### Analyzing $addslashes()
![codeSlash](/images/ATutor/addslashesCode.png)
<sub><sup>Figure 6. Piece of code from mysql_connect.inc.php</sup></sub>

As we can see in figure 6 the first line checks if get magic quotes is enabled, note that i'm using php5.6 (we need PHP 5.0.2+ to install ATutor and php 7 is not supported on ATutor 2.2.1) and get_magic_quotes has been deprecated in php5.3 and removed in php5.4 if i remember correctly, so in this case our code will jump to the else where it checks if MYSQLIi is enabled (it is) and then we have the line *$addslashes = 'trim'* (As you can see is not filtering anything in this case)

So, if we have php5.4+ that means that we don't have get_magic_quotes enabled and $addslashes() is not going to do anything...

Now that we know what $addslashes is doing, let's see how the function searchFriends works

### Analyzing searchFriends function


 


